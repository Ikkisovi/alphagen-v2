# Ensemble训练系统 - 数据准备指南

## 概述

运行Ensemble Alpha Mining系统需要准备以下数据：

1. **价格数据**（必需）：OHLCV + VWAP
2. **基本面数据**（推荐）：33个财务指标
3. **时间范围**：2023-01-01 至 2024-03-31（最少）

---

## 快速开始

### 选项1：使用Qlib自动下载（推荐）

```bash
# 下载中国股票数据（CSI300/CSI500）
python scripts/download_qlib_cn_data.py --start 2022-01-01 --end 2024-12-31
```

### 选项2：手动下载

```bash
# 克隆qlib数据脚本
git clone https://github.com/microsoft/qlib.git
cd qlib

# 下载中国数据
python scripts/get_data.py qlib_data --target_dir ~/.qlib/qlib_data/cn_data --region cn
```

---

## 详细步骤

### 第1步：安装依赖

```bash
pip install qlib yfinance pandas numpy
```

### 第2步：下载价格数据

#### 方法A：使用Qlib（中国市场）

```python
import qlib
from qlib.data import D
from qlib.config import REG_CN

# 初始化qlib
qlib.init(provider_uri='~/.qlib/qlib_data/cn_data', region=REG_CN)

# 验证数据
calendar = D.calendar(start_time='2023-01-01', end_time='2024-03-31')
print(f"交易日数量: {len(calendar)}")

instruments = D.instruments(market='csi300')
print(f"CSI300股票数量: {len(instruments)}")
```

#### 方法B：使用自定义数据

如果你有自己的数据源，需要转换为Qlib格式：

```python
import pandas as pd
from pathlib import Path

# 你的数据格式
# date, symbol, open, high, low, close, volume, vwap
df = pd.read_csv('your_data.csv')

# 转换为qlib格式并保存
# 参考：https://qlib.readthedocs.io/en/latest/component/data.html#converting-csv-format-into-qlib-format
```

### 第3步：准备基本面数据（可选但推荐）

系统支持33个基本面特征，分为5类：

#### 1. 估值比率（6个）
- PERatio（市盈率）
- PBRatio（市净率）
- PSRatio（市销率）
- EVToEBITDA（企业价值/EBITDA）
- EVToRevenue（企业价值/营收）
- EVToFCF（企业价值/自由现金流）

#### 2. 收益率指标（4个）
- EarningYield（盈利收益率）
- FCFYield（自由现金流收益率）
- SalesYield（销售收益率）
- DividendYield（股息率）

#### 3. 增长指标（3个）
- RevenueGrowth（营收增长率）
- EarningsGrowth（盈利增长率）
- BookValueGrowth（账面价值增长率）

#### 4. 财务健康/杠杆（4个）
- DebtToAssets（资产负债率）
- DebtToEquity（产权比率）
- CurrentRatio（流动比率）
- QuickRatio（速动比率）

#### 5. 盈利能力（6个）
- ROE（净资产收益率）
- ROA（总资产收益率）
- ROIC（投资资本回报率）
- GrossMargin（毛利率）
- OperatingMargin（营业利润率）
- NetMargin（净利率）

#### 准备基本面数据的方法：

**选项A：使用项目内置脚本**

如果你有 `uniorganize_fundamental_data.txt` 文件：

```bash
# 构建基本面数据集
python scripts/build_fundamental_dataset.py
```

**选项B：从yfinance获取**

```python
import yfinance as yf
import pandas as pd

# 获取股票基本面数据
ticker = yf.Ticker("AAPL")
info = ticker.info

# 提取需要的指标
fundamental_data = {
    'pe_ratio': info.get('trailingPE'),
    'pb_ratio': info.get('priceToBook'),
    'ps_ratio': info.get('priceToSalesTrailing12Months'),
    'debt_to_equity': info.get('debtToEquity'),
    'roe': info.get('returnOnEquity'),
    'roa': info.get('returnOnAssets'),
    # ... 其他指标
}
```

**选项C：从Wind/彭博等数据源**

如果你有专业数据源，导出CSV格式并使用脚本转换。

### 第4步：验证数据完整性

运行验证脚本：

```bash
python scripts/download_qlib_cn_data.py --start 2023-01-01 --end 2024-03-31
```

期望输出：
```
================================================================================
QLIB DATA DOWNLOAD
================================================================================
Start Date: 2023-01-01
End Date: 2024-03-31
Data Directory: ~/.qlib/qlib_data/cn_data

Initializing Qlib...
✓ Qlib initialized with data at: /home/user/.qlib/qlib_data/cn_data

Verifying data availability...
✓ Calendar: 245 trading days
  First date: 2023-01-03
  Last date: 2024-03-29
✓ CSI300 instruments: 300 stocks
✓ Sample data for SH600000: 245 rows
✓ Fundamental data available: 245 rows

================================================================================
DATA DOWNLOAD COMPLETE
================================================================================
```

---

## 数据要求详解

### 最小数据集（仅价格）

如果没有基本面数据，系统仍可运行，但只使用技术指标：

```yaml
# 修改 config/ensemble_config.yaml
training:
  stage1_technical:
    enabled: true
  stage2_fundamentals:
    enabled: false  # 禁用基本面阶段
```

**最小字段**：
- Date（日期）
- Symbol（股票代码）
- Open, High, Low, Close（OHLC）
- Volume（成交量）
- VWAP（成交均价）

### 完整数据集（价格+基本面）

**时间范围**：
```
训练窗口:
- 12M: 2023-01-01 → 2023-12-31
- 6M:  2023-07-01 → 2023-12-31
- 3M:  2023-10-01 → 2023-12-31
验证窗口:
- 2024-01-01 → 2024-03-31
```

**股票池**：
- CSI300（沪深300）或 CSI500（中证500）
- 可选：添加科技股（AAPL, GOOGL, AMZN, NVDA, SNDK）

**频率**：
- 日线数据（推荐）
- 也支持分钟数据（需更多存储空间）

---

## 数据存储位置

### 默认路径
```
~/.qlib/qlib_data/
└── cn_data/
    ├── calendars/
    ├── instruments/
    ├── features/
    │   ├── sh600000.data
    │   ├── sh600001.data
    │   └── ...
    └── fundamental/  # 如果有基本面数据
        ├── pe_ratio/
        ├── pb_ratio/
        └── ...
```

### 自定义路径

```yaml
# 在 config/ensemble_config.yaml 中配置
universe:
  qlib_data_path: "/path/to/your/qlib/data"
```

或在代码中：

```python
from alphagen_qlib.stock_data import initialize_qlib

initialize_qlib("/path/to/your/qlib/data")
```

---

## 常见问题

### Q1: 数据下载失败

**错误**: `Connection refused` 或 `Timeout`

**解决方案**:
```bash
# 方法1：使用镜像源
export QLIB_DATA_SOURCE="https://mirror.example.com/qlib_data"

# 方法2：手动下载预构建的数据
wget https://github.com/microsoft/qlib/releases/download/data/qlib_bin.tar.gz
tar -xzf qlib_bin.tar.gz -C ~/.qlib/qlib_data/
```

### Q2: 基本面数据缺失

**错误**: `KeyError: 'pe_ratio'`

**解决方案**:
1. 禁用基本面阶段（见上文"最小数据集"）
2. 或手动填充缺失值：

```python
import pandas as pd
import numpy as np

# 前向填充
df['pe_ratio'] = df.groupby('symbol')['pe_ratio'].fillna(method='ffill')

# 或使用行业平均值
industry_avg = df.groupby('industry')['pe_ratio'].transform('mean')
df['pe_ratio'] = df['pe_ratio'].fillna(industry_avg)
```

### Q3: 内存不足

**错误**: `MemoryError` when loading data

**解决方案**:
```yaml
# 减少时间窗口
time_windows:
  train_12m:
    start_date: "2023-07-01"  # 改为6个月

# 或减少股票池
universe:
  base_instrument: "custom"
  custom_stocks: ["SH600000", "SH600001", ...]  # 仅50只股票
```

### Q4: 日期超出范围

**错误**: `DateOutOfRange`

**解决方案**:
```python
# 检查qlib数据的实际范围
from qlib.data import D
cal = D.calendar()
print(f"数据起始日期: {cal[0]}")
print(f"数据结束日期: {cal[-1]}")

# 修改config中的日期以匹配实际范围
```

### Q5: 数据格式不兼容

**错误**: `ValueError: Invalid data format`

**解决方案**:

确保数据符合Qlib格式要求：

```python
# Qlib期望的格式:
# - MultiIndex: (datetime, instrument)
# - Columns: feature names (e.g., 'close', 'volume')
# - Values: numeric (float32/float64)

# 转换示例
df = df.set_index(['date', 'symbol'])
df = df.astype('float32')
```

---

## 数据检查清单

在运行训练前，确保：

- [ ] Qlib已安装并初始化
- [ ] 数据时间范围覆盖 2023-01-01 至 2024-03-31
- [ ] 股票池包含至少100只股票
- [ ] 价格数据（OHLCV + VWAP）完整
- [ ] （可选）基本面数据至少包含估值比率
- [ ] 运行测试脚本验证：`python scripts/test_ensemble.py`

---

## 下一步

数据准备完成后：

1. **运行测试**：
   ```bash
   python scripts/test_ensemble.py
   ```

2. **开始训练**：
   ```bash
   python scripts/train_ensemble.py
   ```

3. **查看结果**：
   ```bash
   cat output/ensemble/ensemble_report_2024Q1.txt
   ```

---

## 参考资源

- **Qlib文档**: https://qlib.readthedocs.io/
- **数据格式**: https://qlib.readthedocs.io/en/latest/component/data.html
- **基本面数据**: [scripts/build_fundamental_dataset.py](../scripts/build_fundamental_dataset.py)
- **完整指南**: [ENSEMBLE_TRAINING.md](ENSEMBLE_TRAINING.md)

---

**更新时间**: 2024-11-02
**版本**: 1.0
